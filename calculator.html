<link href="https://cdn.jsdelivr.net/npm/select2@4.0.13/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/jquery@3.5.0/dist/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.0.13/dist/js/select2.min.js"></script>

<style>
    #airports {
        text-align: center;
    }
</style>

<script type="text/javascript">
    // TODO:
    // - Select round-trip or not
    // - Add more flights? (lower priority)
    // - Fix the flight emissions conversion factor
    // - Add sources
    // - Add example flights, most common routes
    // - Add percentage of carbon budget

    const MILES_PER_KM = 0.6213712;
    const POUNDS_PER_KG = 2.204623;
    const SQ_FT_PER_SQ_M = 10.76391;

    let data = null;
    let departure = null;
    let arrival = null;

    let $departureSelect = null;
    let $arrivalSelect = null;

    function recompute() {
        if (departure === null || arrival === null) return;

        const earthRadius = 6378.137; // kilometers
        let dLat = (arrival.lat - departure.lat) * Math.PI / 180;
        let dLon = (arrival.long - departure.long) * Math.PI / 180;
        let a = Math.pow(Math.sin(dLat / 2), 2) +
            Math.pow(Math.sin(dLon / 2), 2) *
            Math.cos(departure.lat * Math.PI / 180) * Math.cos(arrival.lat * Math.PI / 180);
        let distance = 2 * earthRadius * Math.asin(Math.sqrt(a));

        $("#distance").text(
            (distance * MILES_PER_KM).toLocaleString(undefined, {maximumFractionDigits: 0})
            + " miles or "
            + distance.toLocaleString(undefined, {maximumFractionDigits: 0})
            + " km");

        // 90g/km and 1.9x multplier is pretty consensus. Plus 8% for indirect flights and delays.
        const kgCo2PerKm = 0.09 * 1.9 * 1.08;
        let emissions = 2 * distance * kgCo2PerKm;
        $("#emissions").text(
            (emissions * POUNDS_PER_KG).toLocaleString(undefined, {maximumFractionDigits: 0})
            + " lb or "
            + emissions.toLocaleString(undefined, {maximumFractionDigits: 0})
            + " kg CO2 equivalent");

        const vegReductionPerYear = 540.0; // kilograms
        let veg = emissions / vegReductionPerYear;
        $("#veg").text(veg.toLocaleString(undefined, {maximumFractionDigits: 1}) + " years");

        const carpoolReductionPerYear = 1017.0; // kilograms
        let carpool = emissions / carpoolReductionPerYear;
        $("#carpool").text(carpool.toLocaleString(undefined, {maximumFractionDigits: 1}) + " years");

        const bigMacKg = 4;
        let bigmac = emissions / 4;
        $("#bigmac").text(bigmac.toLocaleString(undefined, {maximumFractionDigits: 0}));

        const iceFactor = 0.003; // 3 sq meters per ton of CO2
        let seaice = emissions * iceFactor;
        $("#seaice").text(
            (seaice * SQ_FT_PER_SQ_M).toLocaleString(undefined, {maximumFractionDigits: 1})
            + " square feet or "
            + seaice.toLocaleString(undefined, {maximumFractionDigits: 1})
            + " square meters");

    }

    function setAirports(iata1, iata2) {
        let airport1 = data.find(e => e.id === iata1);
        let airport2 = data.find(e => e.id === iata2);
        $departureSelect.val(iata1).trigger("change")
            .trigger({ type: 'select2:select', params: { data: airport1 } });
        $arrivalSelect.val(iata2).trigger("change")
            .trigger({ type: 'select2:select', params: { data: airport2 } });
    }

    // Note: the name of this function is hardcoded into the JS file due to JSONP
    // Must use JSONP due to CORS and because Squarespace static assets get redirected
    // from flightfreeusa.org to squarespace.com, so we can't use for storing static assets.
    function jsonpCallback(d) {
        data = d;
        data.forEach(element => {
            element.text = element.id + " - " + element.name;
        });

        $departureSelect = $("#departure");
        $arrivalSelect = $("#arrival");

        $departureSelect.select2({
            data: data,
            placeholder: "Departure Airport (e.g., SFO)",
        });

        $arrivalSelect.select2({
            data: data,
            placeholder: "Arrival Airport (e.g., JFK)",
        });

        $departureSelect.on("select2:select", function(e) {
            departure = e.params.data;
            recompute();
        });

        $arrivalSelect.on("select2:select", function(e) {
            arrival = e.params.data;
            recompute();
        });

        // Start with some defaults.
        setAirports("SFO", "JFK");
    }

    $(function() {
        $("#departure").select2({ placeholder: "Loading..." });
        $("#arrival").select2({ placeholder: "Loading..." });
        const url = "https://cdn.jsdelivr.net/gh/thenovices/flight-calculator/data/data-jsonp.js";
        $.getJSON(url + "?callback=?");
    });
</script>

<div id="airports">
    <select id="departure" class="airport-select" name="departure" style="width: 300px;">
        <option></option>
    </select>
    <select id="arrival" class="airport-select" name="arrival" style="width: 300px;">
        <option></option>
    </select>
</div>

<ul>
    <li>Distance (each way): <span id="distance">N/A</span></li>
    <li>Round-trip Emissions: <span id="emissions">N/A</span></li>
    <li>Avoiding this trip is as climate friendly as being Vegetarian for: <span id="veg">N/A</span></li>
    <li>Avoiding this trip is as climate friendly as Carpooling for: <span id="carpool">N/A</span></li>
    <li>Taking this trip is like eating this many Cheeseburgers: <span id="bigmac">N/A</span></li>
    <li>These emissions melt this much Arctic Sea Ice: <span id="seaice">N/A</span></li>
</ul>